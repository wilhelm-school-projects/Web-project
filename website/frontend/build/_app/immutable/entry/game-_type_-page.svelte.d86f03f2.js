var K=Object.defineProperty;var Q=(a,e,t)=>e in a?K(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(Q(a,typeof e!="symbol"?e+"":e,t),t),N=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var d=(a,e,t)=>(N(a,e,"read from private field"),t?t.call(a):e.get(a)),m=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)},v=(a,e,t,s)=>(N(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t);var A=(a,e,t)=>(N(a,e,"access private method"),t);import{O as w,S as Z,i as ee,s as te,k as P,q as se,a as ae,l as I,m as b,r as ne,h as y,c as re,n as p,b as ie,D as f,H as B,I as oe,o as le}from"../chunks/index.71153ec7.js";import{p as ce}from"../chunks/stores.78cd6a18.js";import{d as he,C as _,u as ue,r as C,s as de,o as pe,g as j,b as ge}from"../chunks/stores.ecf00355.js";class ${constructor(e,t,s,n,i,o){r(this,"xPos");r(this,"yPos");r(this,"color","0,0,0");r(this,"alpha",1);r(this,"gamectx");r(this,"gameCanvas");this.gamectx=i,this.gameCanvas=o,this.xPos=e,this.yPos=t,this.color=s,this.alpha=n}draw(){}equals(e){return!0}setColor(e){console.log("settings color: "+e)}hideMe(){console.log("Hiding me :(")}displayMe(){console.log("Displaing me :)")}}class D extends ${constructor(t,s,n,i,o,l,u,c){super(t,s,o,l,u,c);r(this,"radius");r(this,"endAngle",2);this.radius=n,this.endAngle=i,this.draw()}draw(){let[t,s,n]=this.color.split(",");this.gamectx.beginPath(),this.gamectx.fillStyle=`rgba(${t}, ${s}, ${n}, ${this.alpha})`,this.gamectx.arc(this.xPos,this.yPos,this.radius,0,Math.PI*this.endAngle),this.gamectx.closePath(),this.gamectx.fill()}equals(t){return this.alpha===t.alpha&&this.color===t.color&&this.endAngle===t.endAngle&&this.radius===t.radius&&this.xPos===t.xPos&&this.yPos===t.yPos}}class me extends ${draw(){}}class U{constructor(e,t){r(this,"xPosMouse");r(this,"yPosMouse");r(this,"currentShape");r(this,"controlsCanvas");r(this,"hasPainted",!1);r(this,"stoppedPaintingJustNow",!1);r(this,"oldLengths");r(this,"shapes");r(this,"drawInterval");r(this,"gamectx");r(this,"gameCanvas");if(this.controlsCanvas=t,this.gameCanvas=document.getElementById(e),this.gameCanvas==null)throw new Error("Game Canvas is null!");this.gamectx=this.gameCanvas.getContext("2d"),this.gameCanvas.height=window.innerHeight,this.gameCanvas.width=window.innerWidth,setInterval(()=>this.updateHasPainted(),500),this.gameCanvas.addEventListener("mousemove",s=>{this.xPosMouse=s.clientX,this.yPosMouse=Math.round(s.clientY-this.gameCanvas.getBoundingClientRect().top)}),this.gameCanvas.addEventListener("mousedown",s=>{this.drawInterval=setInterval(()=>this.drawCurrentShape(s),50),console.log("drraw")}),this.gameCanvas.addEventListener("mouseup",()=>{clearInterval(this.drawInterval)}),this.gameCanvas.addEventListener("mouseout",()=>{clearInterval(this.drawInterval)}),this.shapes={rectangles:[],circles:[]},this.currentShape="circle",this.oldLengths={rectangles:0,circles:0}}async updateHasPainted(){let e=!1;for(const t of Object.keys(this.shapes))this.shapes[t].length!==this.oldLengths[t]&&(e=!0,this.oldLengths[t]=this.shapes[t].length);this.hasPainted=e}drawCurrentShape(e){let t=.7;if(this.currentShape=="circle"){let s=10,n=2;this.shapes.circles.push(new D(this.xPosMouse,this.yPosMouse,s,n,"00, 00, 255",t,this.gamectx,this.gameCanvas))}else this.currentShape=="rectangle"&&this.shapes.rectangles.push(new me(this.xPosMouse,this.yPosMouse,"255,00,00",t,this.gamectx,this.gameCanvas))}drawAllShapes(){if(this.shapes!==null)for(const e of Object.keys(this.shapes))this.shapes[e].forEach(t=>{t.draw()})}getShapes(){let e={},t;for(const s of Object.keys(this.shapes)){e[s]=[];for(const n of this.shapes[s])t={alpha:n.alpha,color:n.color,endAngle:2,radius:10,xPos:n.xPos,yPos:n.yPos},e[s].push(t)}return e}thinCanvas(){for(const e of Object.keys(this.shapes))for(let t=0;t<this.shapes[e].length;){if(this.shapes[e].length===0)continue;let s=this.shapes[e][t],n=0;if(this.shapes[e].forEach(i=>{s.equals(i)&&n++}),n>1){let i=this.shapes[e].indexOf(s);this.shapes[e].splice(i,1)}else t++}}reloadContext(e){this.gamectx.clearRect(0,0,this.gameCanvas.width,this.gameCanvas.height),this.shapes={rectangles:[],circles:[]};for(const t of Object.keys(e))e[t].forEach(s=>{this.shapes[t].push(new D(s.xPos,s.yPos,s.radius,s.endAngle,s.color,s.alpha,this.gamectx,s.gameCanvas))})}}class G{constructor(e,t,s){r(this,"painter");r(this,"Networker");r(this,"game");r(this,"canvasWrapper");r(this,"drawButton");if(this.painter=e,this.Networker=t,this.game=s,this.canvasWrapper=document.getElementById("canvas-wrapper"),this.drawButton=document.getElementById("button-Draw-drawing-pane"),s instanceof z){let i=document.getElementById("canvas-wrapper");i.style.pointerEvents="none",i.style.cursor="not-allowed"}document.getElementById("button-Draw-drawing-pane").addEventListener("click",async()=>{this.painter.controlsCanvas?(this.lockCanvas(),await this.Networker.removeCanvasControl()):this.obtainCanvasControl()})}async obtainCanvasControl(){try{let e=await this.Networker.requestCanvasControl();this.unlockCanvas()}catch(e){this.animationNotLoggedInButton(),console.log("Couldn't obtain canvas control:"),console.log(e)}}async animationNotLoggedInButton(){this.drawButton.style.backgroundColor="red",await new Promise(e=>setTimeout(e,600)),this.drawButton.style.backgroundColor="green",await new Promise(e=>setTimeout(e,400)),this.drawButton.style.backgroundColor="red",await new Promise(e=>setTimeout(e,200)),this.drawButton.style.backgroundColor="green",await new Promise(e=>setTimeout(e,200)),this.drawButton.style.backgroundColor="red",await new Promise(e=>setTimeout(e,1e3)),this.drawButton.style.backgroundColor=""}lockCanvas(){this.painter.controlsCanvas=!1,this.canvasWrapper.style.pointerEvents="none",this.canvasWrapper.style.cursor="not-allowed",this.painter.stoppedPaintingJustNow=!0,this.Networker.initiateShapeRetrieval(),this.drawButton.style.backgroundColor=""}unlockCanvas(){this.canvasWrapper.style.pointerEvents="",this.canvasWrapper.style.cursor="",this.Networker.stopShapeRetrieval(),this.painter.controlsCanvas=!0,this.drawButton.style.backgroundColor="green"}}class V{constructor(e){r(this,"painter");r(this,"database");r(this,"stopShapeRetrieval");this.painter=e,this.database=w(he)}async updateShapes(e){try{let t=w(_)+"/shapes",s=await this.sendUpdate(e,t)}catch(t){return console.log("Update failed"),console.log(t),!1}return!0}async setShapes(e){try{let t=await this.sendSet(e,w(_));console.log("Set: successful")}catch(t){return console.log("Send shapes error:"),console.log(t),!1}return!0}async sendUpdate(e,t){let s={};s[t]=e,await ue(C(this.database),s)}async sendSet(e,t){await de(C(this.database,t),e)}initiateShapeRetrieval(){let e=w(_)+"/shapes";this.stopShapeRetrieval=pe(C(this.database,e),t=>{let s=t.val();s===null&&(s={}),this.painter.reloadContext(s)})}async canvasIsControlled(e){try{if(!(await j(C(this.database,e))).exists())return!1}catch(t){return console.log("(canvasIsControlled) Failure:"),console.log(t),!1}return!0}async requestCanvasControl(){return new Promise(async(e,t)=>{let s=localStorage.getItem("email");if(s===null){t("(reuquestCanvasControl) user email doens't exist in localstorage");return}s=encodeURIComponent(s).replace(".","%2E");let n=w(_)+"/control";if(await this.canvasIsControlled(n)){t("(requestCanvasControl) canvas is being controlled by someone else");return}await this.sendUpdate(s,n);try{let i=await j(C(this.database,n));if(!i.exists()){t("(requestCanvasControl) no email exists even though we tried to grab control");return}if(i.val()!==s){t("Another user controls the canvas");return}}catch{t("(requestCanvasControl) fireGet failed when checking if we got control:");return}e("Successfully grabbed control over canvas")})}async removeCanvasControl(){let e=w(_)+"/control";await ge(C(this.database,e))}}var E={},k={};Object.defineProperty(k,"__esModule",{value:!0});k.SetIntervalAsyncTimer=void 0;const ve=10,we=2147483647;var g,h,S,x,H,T,J;const L=class{constructor(){m(this,x);m(this,T);m(this,g,void 0);m(this,h,void 0);m(this,S,!1)}static startTimer(e,t,s,...n){var o;s=Math.min(Math.max(Math.trunc(s),ve),we);const i=new L;return A(o=i,x,H).call(o,e,t,s,s,...n),i}static async stopTimer(e){v(e,S,!0),d(e,g)&&clearTimeout(d(e,g)),d(e,h)&&await d(e,h)}};let M=L;g=new WeakMap,h=new WeakMap,S=new WeakMap,x=new WeakSet,H=function(e,t,s,n,...i){v(this,g,setTimeout(async()=>{v(this,g,void 0),v(this,h,A(this,T,J).call(this,e,t,s,...i)),await d(this,h),v(this,h,void 0)},n))},T=new WeakSet,J=async function(e,t,s,...n){const i=new Date().getTime();try{await t(...n)}finally{if(!d(this,S)){const o=new Date().getTime()-i,l=e==="dynamic"?s>o?s-o:0:s;A(this,x,H).call(this,e,t,s,l,...n)}}};k.SetIntervalAsyncTimer=M;Object.defineProperty(E,"__esModule",{value:!0});var F=E.clearIntervalAsync=void 0;const W=k;async function ye(a){if(!(a instanceof W.SetIntervalAsyncTimer))throw new TypeError("First argument is not an instance of SetIntervalAsyncTimer");await W.SetIntervalAsyncTimer.stopTimer(a)}F=E.clearIntervalAsync=ye;var X={};(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.setIntervalAsync=a.clearIntervalAsync=void 0;const e=E;Object.defineProperty(a,"clearIntervalAsync",{enumerable:!0,get:function(){return e.clearIntervalAsync}});const t=k;function s(n,i,...o){if(typeof n!="function")throw new TypeError("First argument is not a function");if(typeof i!="number")throw new TypeError("Second argument is not a number");return t.SetIntervalAsyncTimer.startTimer("dynamic",n,i,...o)}a.setIntervalAsync=s})(X);class Y{constructor(){r(this,"gameCanvas");r(this,"gamectx");r(this,"painter");r(this,"settingsHandler");r(this,"Networker");r(this,"intervalAsyncTimer");this.intervalAsyncTimer=X.setIntervalAsync(async()=>{await this.transmitShapes()},50),setInterval(()=>{this.painter.controlsCanvas&&this.painter.thinCanvas()},5e3),window.onbeforeunload=()=>{this.cleanUp()}}async transmitShapes(){if(this.painter.stoppedPaintingJustNow){this.painter.stoppedPaintingJustNow=!1;return}if(!this.painter.controlsCanvas||!this.painter.hasPainted)return;this.painter.hasPainted=!1;let e=this.painter.getShapes();try{let t=await this.Networker.updateShapes(e)}catch{console.log("Transimitting shapes didn't go as planned")}}cleanUp(){F(this.intervalAsyncTimer),this.painter.controlsCanvas&&this.Networker.removeCanvasControl()}}class fe extends Y{constructor(e){super(),this.painter=new U(e,!0),this.Networker=new V(this.painter),this.settingsHandler=new G(this.painter,this.Networker,this)}}class z extends Y{constructor(e){super(),this.painter=new U(e,!1),this.Networker=new V(this.painter),this.settingsHandler=new G(this.painter,this.Networker,this),this.Networker.initiateShapeRetrieval()}}function Ce(a){return console.log(a),a=="host"?new fe("game-canvas"):new z("game-canvas")}function Pe(a){let e,t,s,n,i,o,l;return{c(){e=P("main"),t=P("div"),s=P("h1"),n=se(a[0]),i=ae(),o=P("div"),l=P("canvas"),this.h()},l(u){e=I(u,"MAIN",{class:!0});var c=b(e);t=I(c,"DIV",{class:!0});var O=b(t);s=I(O,"H1",{class:!0});var R=b(s);n=ne(R,a[0]),R.forEach(y),O.forEach(y),i=re(c),o=I(c,"DIV",{id:!0,class:!0});var q=b(o);l=I(q,"CANVAS",{id:!0,class:!0}),b(l).forEach(y),q.forEach(y),c.forEach(y),this.h()},h(){p(s,"class","text-center col"),p(t,"class","row"),p(l,"id","game-canvas"),p(l,"class","svelte-oj7mwg"),p(o,"id","canvas-wrapper"),p(o,"class","row"),p(e,"class","game-container")},m(u,c){ie(u,e,c),f(e,t),f(t,s),f(s,n),f(e,i),f(e,o),f(o,l)},p:B,i:B,o:B,d(u){u&&y(e)}}}function Ie(a,e,t){let s;oe(a,ce,i=>t(2,s=i));let n=s.url.href.split("/").at(s.url.href.split("/").length-1);return le(()=>{Ce(n)}),[n]}class ke extends Z{constructor(e){super(),ee(this,e,Ie,Pe,te,{})}}export{ke as default};
